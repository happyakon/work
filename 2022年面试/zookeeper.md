## zookeeper

### 1.选举

> zookeeper使用paxos算法，选举必须获得大于一半的投票才能成为领导者。

#### 1.1 首次选举

> 目前有5台服务器，编号一次是1-5，按编号以此启动zookeeper服务器。
>
> 1. 服务器1启动，首先给自己投票，对集群中启动的其他zookeeper服务器发起投票对比，此时其他服务器都没有启动，服务器1的状态为LOOKING。
> 2. 服务器2启动，首先给自己投票，对集群中启动的其他zookeeper服务器发起投票对比，此时和服务器1交换结果，服务器2的编号大，胜出，服务器1会给服务器2投票，服务器2此时拥有两票，但是仍然小于半数，所以服务器2此时状态为LOOKING。
> 3. 服务器3启动，首先给自己投票，对集群中启动的其他zookeeper服务器发起投票对比，此时和服务器1和服务器2交换结果，因为服务器3编号最大，所以胜出，得到两票，加上自己的1票一共3票，大于半数机器，成为领导者leader。服务器1和服务器2成为跟随者。
> 4. 服务器4启动，发现已经有leader，则自己成为跟随者。
> 5. 服务器5启动，同服务器4一样成为跟随者。

#### 1.2 非首次选举

> 对于正常运行的zookeeper集群，一旦中途有服务器宕机，则需要重新选举，选举的过程需要引入服务器ID，数据ID和逻辑时钟。这是由于zookeeper集群已经运行了一段时间，服务器中会存在数据。
>
> 1. 首先统计逻辑时钟是否相同，逻辑时钟小，则说明途中可能存在宕机问题，因此数据不完整，那么该选举结果被忽略，重新投票选举。
> 2. 其次，统一逻辑时钟后，对比数据ID值，数据ID反应数据的新旧程度，因此数据ID大的胜出。
> 3. 如果数据ID相同和逻辑时钟相同的情况下，对比服务器ID，值大者胜出。