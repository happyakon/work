## seata分布式事务

### 1.什么是Seata?

​    Seata是一个开源的分布式事务解决方案，提供了AT，TCC,SAGA,和XA的事务模式。

#### 1.1 seata模块组成

1. TM(transaction manager)-事务管理器

   > 定义全局事务的范围：开始全局事务、提交或回滚全局事务。

2. RM(resource manager)-资源管理器

   > 管理分支事务处理的资源，与TC交谈以注册分支事务和报告分支事务的状态，并驱动分支事务提交或回滚。

3. TC(transaction coordinador)-事务协调者

   > 维护全局和分支事务的状态，驱动全局事务提交或回滚。

   示例：

   ![image-20220612171725407](D:\gitwork\work\2022年面试\文件\seata.png)

### 2.AT如何工作

#### 2.1 前提条件

2.1.1 基于支持本地 ACID 事务的关系型数据库。

2.1.2 Java 应用，通过 JDBC 访问数据库。

#### 2.2 整体机制

##### 2.2.1 一阶段：

业务数据和回滚日志记录在同一个本地事务中提交，释放本地锁和连接资源。

##### 2.2.2 二阶段：

1. 提交异步化，非常快速地完成。

2. 回滚通过一阶段的回滚日志进行反向补偿。

#### 2.3 写隔离

1. 一阶段本地事务提交前，需要确保先拿到 **全局锁** 。

2. 拿不到 **全局锁** ，不能提交本地事务。

3. 拿 **全局锁** 的尝试被限制在一定范围内，超出范围将放弃，并回滚本地事务，释放本地锁。

### 3.base理论

> BASE理论是Basically Available(基本可用)，Soft State（软状态）和Eventually Consistent（最终一致性）三个短语的缩写。
>
> 既是无法做到强一致性（Strong consistency），但每个应用都可以根据自身的业务特点，采用适当的方式来使系统达到最终一致性（Eventual consistency）。

#### 3.1 基本可用

1. **响应时间上的损失**：正常情况下的搜索引擎0.5秒即返回给用户结果，而基本可用的搜索引擎可以在2秒作用返回结果。
2. **功能上的损失**：在一个电商网站上，正常情况下，用户可以顺利完成每一笔订单。但是到了大促期间，为了保护购物系统的稳定性，部分消费者可能会被引导到一个降级页面。

#### 3.2 软状态

允许系统中的数据存在中间状态，并认为该状态不影响系统的整体可用性，即允许系统在多个不同节点的数据副本存在数据延时。

#### 3.3 最终一致性

> 上面说软状态，然后不可能一直是软状态，必须有个时间期限。在期限过后，应当保证所有副本保持数据一致性，从而达到数据的最终一致性。这个时间期限取决于网络延时、系统负载、数据复制方案设计等等因素。

而在实际工程实践中，最终一致性分为5种：

##### 3.3.1. 因果一致性（Causal consistency）

因果一致性指的是：如果节点A在更新完某个数据后通知了节点B，那么节点B之后对该数据的访问和修改都是基于A更新后的值。于此同时，和节点A无因果关系的节点C的数据访问则没有这样的限制。

##### 3.3.2. 读己之所写（Read your writes）

读己之所写指的是：节点A更新一个数据后，它自身总是能访问到自身更新过的最新值，而不会看到旧值。其实也算一种因果一致性。

##### 3.3.3. 会话一致性（Session consistency）

会话一致性将对系统数据的访问过程框定在了一个会话当中：系统能保证在同一个有效的会话中实现 “读己之所写” 的一致性，也就是说，执行更新操作之后，客户端能够在同一个会话中始终读取到该数据项的最新值。

##### 3.3.4. 单调读一致性（Monotonic read consistency）

单调读一致性指的是：如果一个节点从系统中读取出一个数据项的某个值后，那么系统对于该节点后续的任何数据访问都不应该返回更旧的值。

##### 3.3.5. 单调写一致性（Monotonic write consistency）

单调写一致性指的是：一个系统要能够保证来自同一个节点的写操作被顺序的执行。

在实际的实践中，这5种系统往往会结合使用，以构建一个具有最终一致性的分布式系统。

实际上，不只是分布式系统使用最终一致性，关系型数据库在某个功能上，也是使用最终一致性的。比如备份，数据库的复制过程是需要时间的，这个复制过程中，业务读取到的值就是旧的。当然，最终还是达成了数据一致性。这也算是一个最终一致性的经典案例。

###### 小结:

> 总体来说BASE理论面向的是大型高可用、可扩展的分布式系统。与传统ACID特性相反，不同于ACID的强一致性模型，BASE提出通过牺牲强一致性来获得可用性，并允许数据段时间内的不一致，但是最终达到一致状态。同时，在实际分布式场景中，不同业务对数据的一致性要求不一样。因此在设计中，ACID和BASE理论往往又会结合使用。
